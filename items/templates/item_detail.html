{% extends "base.html" %}
{% load markdownify %}
{% load static %}

{% block content %}
<div class="layout-1">
    <div class="map-header">
        <h1>{{ item.name|escape }} <span>by <a href="{% url 'user' username=item.user %}">{{ item.get_byline|escape }}</a></span></h1>
        {{ version.download_button }}
    </div>
</div>

<div class="layout-1-1">
    <div>
        <h2>Description</h2>
        <div class="markdown">
            {{ item.body|markdownify }}
        </div>

        <h2>Version {{ version.name|escape }}</h2>
        <div class="markdown">
            {{ version.body|markdownify }}
        </div>

        <ul class="details">
            <li>Uploaded {{ version.created_at|date:"M jS, Y" }}</li>

            {% if tags %}
            <li>Tags:
                {% for tag in tags %}
                <a href="{% url 'tag' tag %}">{{ tag }}</a>
                {% endfor %}
            </li>
            {% endif %}

            <li>{{ item.downloads_count }} download{{ item.downloads_count|pluralize }} of this item</li>
            <li>{{ version.downloads_count }} download{{ version.downloads_count|pluralize }} of latest version</li>

            {% if item.reviews_count > 0 %}
            <li>{{ item.rating_average|stringformat:".1f" }} rating ( {{ item.rating_weighted|stringformat:".2f" }} weighted for sorting )</li>
            {% endif %}
        </ul>

        {% if user == item.user %}
            <h2>Controls</h2>

            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="{% url 'item_edit' item.permalink %}" class="button change edit-txt">Edit information</a>
            <a href="{% url 'edit_version' item.permalink version.pk %}" class="button change edit-txt">Edit version</a>
            <a href="{% url 'item_delete' item.permalink %}" class="button danger delete">Delete everything</a>
            <a href="{% url 'version_create' item.permalink %}" class="button positive add">Add version</a>
            </div>
        {% endif %}

        <h2>{{ item.reviews_count }} Review{{item.reviews_count|pluralize}}</h2>

        <div id="map_reviews">
            {% for review in reviews %}
            {% include "_show_review.html" with show=review %}
            {% endfor %}
            {% if user.is_authenticated %}
                <a href="{% url 'new_item_review' item_permalink=item.permalink %}" class="button positive add">Write a review</a>
            {% endif %}
        </div>
    </div>

    <div class="screenshots">
        <h2>{{ item.screenshots_count }} Screenshot{{ item.screenshots_count|pluralize }}</h2>

        {% if user == item.user %}
            <div class="screenshot">
                <a href="{% url 'add_screenshot' item.permalink %}" class="button positive add">Add screenshot</a>
            </div>
        {% endif %}

        {% for screenshot in screenshots %}
        <div class="screenshot">
            {% if screenshot.title %}
                <h3>{{ screenshot.title|escape }}</h3>
            {% endif %}

            <a href="{{ screenshot.file.url }}" target="_blank">
                <img alt="{{ screenshot.label }}" class="screenshot_content" src="{{ screenshot.file_content.url }}">
            </a>

            {% if user == item.user %}
                <div class="button-bar">
                    <a href="{% url 'screenshot_edit' item.permalink screenshot.id %}" class="button change edit-txt">Edit</a>
                    <a href="{% url 'screenshot_delete' item.permalink screenshot.id %}" class="button danger cancel">Delete</a>
                </div>
            {% endif %}
        </div>
        {% endfor %}

        {% if item.screenshots_count < 1 %}
        <img alt="No screenshots" src="{% static 'images/no-screenshots.png' %}">
        {% endif %}
    </div>
</div>
{% endblock %}
